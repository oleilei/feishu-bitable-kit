(e=>{let i;class n extends Error{constructor(e,t,r){super(e),this.name="FeishuBitableError",this.code=t,this.details=r}}class t{constructor(t,r,o,s,e="4.17.21"){var a;if(e&&(a=`https://oss.techclub.plus/libs/${e}/lodash.js`,new Promise((t,r)=>{let o="jsonp_callback_"+Math.round(1e6*Math.random()),s=(window[o]=function(e){try{i=e,t(e)}catch(e){r(new Error("Failed to parse config"))}delete window[o],document.body.removeChild(s)},document.createElement("script"));s.src=a+"?callback="+o,s.onerror=function(){delete window[o],document.body.removeChild(s),r(new Error("Failed to load config"))},document.body.appendChild(s)}).then(e=>{t=t||e.appId,r=r||e.appSecret,o=o||e.appToken,s=s||e.tableId}).catch(e=>{console.warn("Failed to load remote config:",e)})),!(t&&r&&o&&s))throw new n("缺少必要的参数","INVALID_PARAMS",{required:["appId","appSecret","appToken","tableId"]});this.appId=t,this.appSecret=r,this.appToken=o,this.tableId=s,this.baseUrl=`https://open.feishu.cn/open-apis/bitable/v1/apps/${o}/tables/${s}/records`,this.accessToken="",this.tokenExpireTime=0,this.retryCount=3,this.retryDelay=1e3}async makeRequest(s,a,t=0){try{return await new Promise((r,o)=>{if("undefined"!=typeof fetch)fetch(s,{method:a.method||"GET",headers:{...a.headers,Origin:window.location.origin,Referer:window.location.href},body:a.body,mode:"cors",credentials:"omit",timeout:1e4}).then(e=>e.json()).then(e=>{0!==e.code?o(new n(e.msg||"请求失败",e.code,e)):r(e)}).catch(e=>{o(new n("网络请求失败","NETWORK_ERROR",e))});else{let t=new XMLHttpRequest;t.open(a.method||"GET",s),t.timeout=1e4,a.headers&&Object.keys(a.headers).forEach(e=>{t.setRequestHeader(e,a.headers[e])}),t.onload=function(){try{var e=JSON.parse(t.responseText);0!==e.code?o(new n(e.msg||"请求失败",e.code,e)):r(e)}catch(e){o(new n("解析响应失败","PARSE_ERROR",e))}},t.onerror=function(e){o(new n("网络请求失败","NETWORK_ERROR",e))},t.ontimeout=function(){o(new n("请求超时","TIMEOUT_ERROR"))},t.send(a.body)}})}catch(e){if(t<this.retryCount&&(e.message.includes("网络")||e.message.includes("超时")))return await new Promise(e=>setTimeout(e,this.retryDelay)),this.makeRequest(s,a,t+1);throw e}}async getAccessToken(){if(this.accessToken&&Date.now()<this.tokenExpireTime-6e4)return this.accessToken;try{var e=await this.makeRequest("https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({app_id:this.appId,app_secret:this.appSecret})});return this.accessToken=e.tenant_access_token,this.tokenExpireTime=Date.now()+1e3*e.expire,this.accessToken}catch(e){throw console.error("获取访问令牌出错:",e),e}}async getHeaders(){return{"Content-Type":"application/json",Authorization:"Bearer "+await this.getAccessToken()}}async queryRecords(e="",t=10,r=""){try{var o=this.baseUrl+"/search?user_id_type=open_id"+(t?"&page_size="+t:"")+(r?"&page_token="+r:""),s=await this.getHeaders(),a=e?{filter:e}:{};return(await this.makeRequest(o,{method:"POST",headers:s,body:JSON.stringify(a)})).data?.items||[]}catch(e){throw console.error("查询记录出错:",e),e}}async addRecord(e){if(!e||"object"!=typeof e)throw new n("无效的记录数据","INVALID_RECORD",{record:e});try{var t=await this.getHeaders();return(await this.makeRequest(this.baseUrl,{method:"POST",headers:t,body:JSON.stringify({fields:e})})).data.record.id}catch(e){throw console.error("添加记录出错:",e),e}}async updateRecord(e,t){if(!e)throw new n("缺少记录ID","INVALID_RECORD_ID",{recordId:e});if(!t||"object"!=typeof t)throw new n("无效的更新数据","INVALID_FIELDS",{fields:t});try{var r=await this.getHeaders(),o=this.baseUrl+"/"+e;await this.makeRequest(o,{method:"PUT",headers:r,body:JSON.stringify({fields:t})});return!0}catch(e){throw console.error("更新记录出错:",e),e}}async deleteRecord(e){if(!e)throw new n("缺少记录ID","INVALID_RECORD_ID",{recordId:e});try{var t=await this.getHeaders(),r=this.baseUrl+"/"+e;return await this.makeRequest(r,{method:"DELETE",headers:t}),!0}catch(e){throw console.error("删除记录出错:",e),e}}async batchDeleteRecord(e){if(!Array.isArray(e)||0===e.length)throw new n("无效的记录ID列表","INVALID_RECORD_IDS",{recordIds:e});try{var t=await this.getHeaders(),r=this.baseUrl+"/batch_delete";return await this.makeRequest(r,{method:"POST",headers:t,body:JSON.stringify({records:e})}),!0}catch(e){throw console.error("批量删除记录出错:",e),e}}async batchAddRecord(e){if(!Array.isArray(e)||0===e.length)throw new n("无效的记录数据","INVALID_RECORDS",{records:e});try{var t,r=await this.getHeaders(),o=this.baseUrl+"/batch_create",s=[];for(t of e)e.push({fields:t});return(await this.makeRequest(o,{method:"POST",headers:r,body:JSON.stringify({records:s})}))?.data?.records?.map(e=>e.id)}catch(e){throw console.error("批量添加记录出错:",e),e}}setRetryConfig(e,t){if("number"!=typeof e||e<0)throw new n("无效的重试次数","INVALID_RETRY_COUNT",{count:e});if("number"!=typeof t||t<0)throw new n("无效的重试延迟","INVALID_RETRY_DELAY",{delay:t});this.retryCount=e,this.retryDelay=t}}"function"==typeof define&&define.amd?define([],function(){return t}):"object"==typeof exports?module.exports=t:e.FeishuBitable=t})("undefined"!=typeof window?window:this);